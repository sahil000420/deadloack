<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Deadlock Prevention Quiz</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fafafa; }
.container { max-width:760px; margin:auto; padding:15px; }
h2 { text-align:center; margin-bottom:15px; }
.question, .email-section { margin-bottom:20px; padding:12px; border-radius:6px; background:#fff; border:1px solid #ddd; }
label { display:block; margin:6px 0; cursor:pointer; font-size:16px; }
.required { color:red; font-weight:bold; margin-left:4px; }
.small-note { font-size:13px; color:#555; margin-top:5px; }
.switch-link { color:#1a73e8; cursor:pointer; text-decoration:none; }
.switch-link:hover { text-decoration:underline; }
.correct { color:green; font-weight:bold; }
.wrong { color:red; font-weight:bold; }
#warning { color:red; font-weight:bold; margin-bottom:10px; display:none; text-align:center; position:sticky; top:0; background:#fff; padding:5px; z-index:999; }
button { background:#1a73e8; color:white; padding:12px 20px; border:none; border-radius:6px; cursor:pointer; margin-top:10px; font-size:16px; width:100%; }
button:hover { background:#1669c1; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:#fff; margin:20% auto; padding:20px; border-radius:8px; width:85%; max-width:320px; box-shadow:0 4px 10px rgba(0,0,0,0.2); }
.modal-content h3 { margin-top:0; font-size:18px; }
.modal-content input { width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:5px; font-size:16px; }
.modal-buttons { text-align:right; }
.modal-buttons button { margin-left:8px; background:#1a73e8; border:none; color:#fff; padding:8px 14px; border-radius:5px; cursor:pointer; font-size:14px; }
.modal-buttons button.cancel { background:#aaa; }
</style>
</head>
<body>

<div class="container">
<h2>Deadlock Prevention Quiz</h2>

<div id="warning">⚠ Aapne tab switch kiya! Quiz ab lock ho gaya aur score show ho raha hai.</div>

<form id="quizForm">
<div class="email-section">
  <p><strong>Email <span class="required">*</span></strong></p>
  <input type="email" id="email" name="email" required style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; font-size:16px;" placeholder="Enter your email" />
  <p class="small-note">Record <span id="emailDisplay">your.email@example.com</span> as the email to be included with my response. 
  <a class="switch-link" href="#">Switch account</a></p>
</div>

<div id="quizContainer" style="display:none;"></div>

<button type="button" id="startButton" onclick="startQuiz()">Start Quiz</button>
<button type="button" onclick="submitQuiz()">Submit</button>
</form>

<div id="switchModal" class="modal">
  <div class="modal-content">
    <h3>Switch Account</h3>
    <input type="email" id="newEmail" placeholder="Enter new email" />
    <div class="modal-buttons">
      <button class="cancel" onclick="closeModal()">Cancel</button>
      <button onclick="saveNewEmail()">Save</button>
    </div>
  </div>
</div>
</div>

<script>
// ---------------- Quiz Data ----------------
const questions = [
  { q: "Which algorithm is commonly used to prevent deadlocks?", options: ["Banker's Algorithm","Round Robin","FIFO Scheduling","Paging"], answer: "Banker's Algorithm" },
  { q: "Which necessary condition is removed to prevent deadlock?", options: ["Hold and Wait","Starvation","Spooling","Concurrency"], answer: "Hold and Wait" },
  { q: "T/F: Preemption can forcibly take resources from a process to avoid deadlock.", options: ["True","False"], answer: "True" },
  { q: "Which of the following is NOT a necessary condition for deadlock?", options: ["Mutual Exclusion","Hold and Wait","Circular Wait","Starvation"], answer: "Starvation" },
  { q: "Deadlock prevention ensures:", options: ["Deadlock never occurs","Deadlock is detected later","System ignores deadlock","None of these"], answer: "Deadlock never occurs" },
  { q: "Which strategy avoids Hold and Wait?", options: ["Process must request all resources at once","Process requests resources in random order","Use of FIFO queue","Starvation handling"], answer: "Process must request all resources at once" },
  { q: "Circular wait can be prevented by:", options: ["Imposing ordering of resources","Killing a process","Swapping memory","Using paging"], answer: "Imposing ordering of resources" },
  { q: "T/F: Preemption means taking a resource away from a process if needed.", options: ["True","False"], answer: "True" }
];

// Shuffle questions and options
function shuffleArray(array) {
  for (let i=array.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
shuffleArray(questions);

// Render Quiz
const quizContainer = document.getElementById('quizContainer');
questions.forEach((item, idx)=>{
  shuffleArray(item.options);
  let html = `<div class="question" id="q${idx}">
      <p><strong>${idx+1}) ${item.q}<span class="required">*</span></strong></p>`;
  item.options.forEach(opt=>{
    html += `<label><input type="radio" name="q${idx}" value="${opt}"> ${opt}</label>`;
  });
  html += `</div>`;
  quizContainer.innerHTML += html;
});

// Modal functions
const modal = document.getElementById("switchModal");
document.querySelector(".switch-link").addEventListener("click", function(e){
  e.preventDefault();
  document.getElementById("newEmail").value = "";
  modal.style.display = "block";
});
function closeModal(){ modal.style.display = "none"; }
function saveNewEmail(){
  const newEmail = document.getElementById("newEmail").value.trim();
  if(newEmail){
    document.getElementById("email").value = newEmail;
    document.getElementById("emailDisplay").innerText = newEmail;
  }
  closeModal();
}
window.onclick = function(event){ if(event.target==modal) closeModal(); }

// Secure quiz features
let quizLocked = false;
if(localStorage.getItem("quizSubmitted")==="true"){
  document.getElementById("quizForm").innerHTML = "<h3>⚠ You have already attempted this quiz. Score: 0/"+questions.length+"</h3>";
}

function startQuiz(){
  document.getElementById('startButton').style.display='none';
  quizContainer.style.display='block';
  document.querySelector('button[onclick="submitQuiz()"]').style.display='inline-block';
}

// Detect tab switch
document.addEventListener('visibilitychange', function(){
  if(document.hidden && !quizLocked){
    quizLocked = true;
    document.getElementById('warning').style.display='block';
    alert("⚠ Aapne tab switch kiya! Quiz ab lock ho gaya aur score show ho raha hai.");
    forceZeroScore();
  }
});

// Submit & show score
function submitQuiz(){
  const emailField = document.getElementById('email').value.trim();
  if(emailField===""){ alert("⚠ Please enter your email before submitting!"); return; }
  
  let score = 0;
  questions.forEach((item, idx)=>{
    const radios = document.getElementsByName("q"+idx);
    let yourAnswer="";
    for(let r of radios){ if(r.checked){ yourAnswer=r.value; break; } }
    if(yourAnswer===item.answer) score++;
  });

  localStorage.setItem("quizSubmitted","true");
  quizContainer.style.display='none';
  document.querySelector('button[onclick="submitQuiz()"]').style.display='none';
  
  // Auto-submit Google Form
  const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSfvVq8kB343H4_UtkblifHVtFpnXCbF6U26c0UyQnLLmd91ew/formResponse";
  const emailEntryId = "entry.1754360159";
  const scoreEntryId = "entry.1593706799";

  const form = document.createElement("form");
  form.action = formUrl;
  form.method = "POST";
  form.target = "hidden_iframe";

  const emailInput = document.createElement("input");
  emailInput.type="hidden";
  emailInput.name=emailEntryId;
  emailInput.value=emailField;

  const scoreInput = document.createElement("input");
  scoreInput.type="hidden";
  scoreInput.name=scoreEntryId;
  scoreInput.value=score;

  form.appendChild(emailInput);
  form.appendChild(scoreInput);
  document.body.appendChild(form);

  const iframe = document.createElement("iframe");
  iframe.name="hidden_iframe";
  iframe.style.display="none";
  document.body.appendChild(iframe);

  form.submit();
  alert(`Quiz submitted! Your score: ${score}/${questions.length}`);
}

function forceZeroScore(){
  localStorage.setItem("quizSubmitted","true");
  document.getElementById("quizForm").innerHTML = "<h3>⚠ Quiz locked due to tab switch. Score: 0/"+questions.length+"</h3>";
}
</script>

</body>
</html>
